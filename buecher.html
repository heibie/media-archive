---
layout: default
title: B√ºcher
permalink: /buecher/
---

<h1>üìö Gelesene B√ºcher</h1>

<p class="muted">Quelle: <code>_data/read.yml</code> ‚Ä¢ ‚Äûcurrently reading‚Äú immer oben ‚Ä¢ danach neueste zuerst</p>

{%- assign books_all = site.data.read | default: empty -%}
{%- assign books = books_all | where: "typ", "buch" -%}
{%- assign books = books | sort: "fertig_am" | reverse -%}

<div class="controls">
  <div class="group">
    <label for="q">Suche:</label>
    <input id="q" type="search" placeholder="Titel oder Autor‚Ä¶">
  </div>
  <div class="group">
    <label for="status">Status:</label>
    {%- comment -%}
      Sammle Status-Werte aus den Eintr√§gen
    {%- endcomment -%}
    {%- assign all_status = "" | split: "" -%}
    {%- for b in books -%}
      {%- if b.status -%}
        {%- assign s_arr = b.status | append: '' | split: '__' -%}
        {%- assign all_status = all_status | concat: s_arr -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign status_unique = all_status | uniq | sort -%}
    <select id="status">
      <option value="">(alle)</option>
      {%- for s in status_unique -%}
        {%- if s -%}<option value="{{ s | escape }}">{{ s }}</option>{%- endif -%}
      {%- endfor -%}
    </select>
  </div>
  <div class="group">
    <label for="year">Jahr:</label>
    {%- comment -%}
      Ziehe Jahr aus 'fertig_am' oder Fallbacks
    {%- endcomment -%}
    {%- assign all_years = "" | split: "" -%}
    {%- for b in books -%}
      {%- assign date_source = b.fertig_am | default: b.eingetragen_am | default: b.hinzugefuegt_am | default: b.start_am | default: b.gestartet_am | default: b.datum -%}
      {%- if date_source -%}
        {%- assign y = date_source | date: "%Y" -%}
        {%- assign y_arr = y | split: '__' -%}
        {%- assign all_years = all_years | concat: y_arr -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign years_unique = all_years | uniq | sort | reverse -%}
    <select id="year">
      <option value="">(alle)</option>
      {%- for y in years_unique -%}
        <option value="{{ y }}">{{ y }}</option>
      {%- endfor -%}
    </select>
  </div>
  <label class="toggle">
    <input id="hide-nocover" type="checkbox"> ohne Cover ausblenden
  </label>
  <span class="pill muted" id="count"></span>
</div>

<div id="grid" class="grid">
{%- for b in books -%}
  {%- assign cover = b.cover -%}
  {%- assign isbn_str = b.isbn | append: '' -%}
  {%- if (cover == nil or cover == "" or cover contains "nopic.png" or cover contains "/assets/placeholder.png") and b.isbn -%}
    {%- assign cover = "https://covers.openlibrary.org/b/isbn/" | append: isbn_str | append: "-L.jpg" -%}
  {%- endif -%}

  {%- assign authors_text = "" -%}
  {%- if b.autor -%}
    {%- if b.autor.size -%}{%- assign authors_text = b.autor | join: ", " -%}{%- else -%}{%- assign authors_text = b.autor -%}{%- endif -%}
  {%- endif -%}

  {%- assign status = b.status | default: "" | downcase | strip -%}
  {%- assign pages_num = b.seiten | default: b.Seiten | default: 0 | plus: 0 -%}
  {%- assign progress_num = b.progress | default: 0 | plus: 0 -%}
  {%- assign rating_num = b.bewertung | replace: ",","." | default: 0 | plus: 0 -%}
  {%- if status == "to read" -%}{%- assign status = "want to read" -%}{%- endif -%}

  {%- comment -%} Datum f√ºr Anzeige & Sortierung {%- endcomment -%}
  {%- assign date_label = "" -%}
  {%- assign date_value = "" -%}
  {%- if status == "finished" -%}
    {%- assign date_label = "beendet" -%}
    {%- assign date_value = b.fertig_am | default: b.eingetragen_am | default: b.datum -%}
  {%- elsif status == "want to read" -%}
    {%- assign date_label = "hinzugef√ºgt" -%}
    {%- assign date_value = b.eingetragen_am | default: b.hinzugefuegt_am | default: b.datum -%}
  {%- elsif status == "currently reading" -%}
    {%- assign date_label = "gestartet" -%}
    {%- assign date_value = b.start_am | default: b.gestartet_am | default: b.eingetragen_am | default: b.datum -%}
  {%- else -%}
    {%- assign date_value = b.eingetragen_am | default: b.fertig_am | default: b.datum -%}
  {%- endif -%}

  {%- assign year = "" -%}{%- if date_value -%}{%- assign year = date_value | date: "%Y" -%}{%- endif -%}

  {%- comment -%}
    Pin-Kriterium: status == currently reading UND kein fertig_am ‚Üí ganz oben
  {%- endcomment -%}
  {%- assign is_pin = 0 -%}
  {%- if status == "currently reading" and (b.fertig_am == nil or b.fertig_am == "") -%}
    {%- assign is_pin = 1 -%}
  {%- endif -%}

  {%- comment -%}
    Fortschritt (optional)
  {%- endcomment -%}
  {%- assign pct = "" -%}
  {%- if status == "currently reading" and pages_num > 0 and progress_num > 0 -%}
    {%- assign pct = progress_num | times: 100.0 | divided_by: pages_num | round -%}
  {%- endif -%}

  <article class="card"
    data-title="{{ b.titel | default: 'Ohne Titel' | downcase | escape }}"
    data-author="{{ authors_text | downcase | escape }}"
    data-status="{{ status | downcase | escape }}"
    data-year="{{ year }}"
    data-rating="{{ rating_num }}"
    data-date="{{ date_value }}"
    data-pin="{{ is_pin }}"
  >
    {%- if is_pin == 1 -%}
      <span class="badge badge-running" title="Aktuell in Arbeit">üìñ l√§uft</span>
    {%- endif -%}
    <img loading="lazy"
      src="{{ cover | default: '/assets/placeholder.png' | relative_url }}"
      alt="Cover"
      onerror="this.onerror=null; this.dataset.error=1; this.src='{{ '/assets/placeholder.png' | relative_url }}'; this.closest('.card').dataset.nocover='1'; if(document.getElementById('hide-nocover')?.checked){ this.closest('.card').style.display='none'; }"
    >
    <div class="body">
      <h2 title="{{ b.titel | escape }}">{{ b.titel | default: "Ohne Titel" }}</h2>
      {%- if authors_text != "" -%}<div class="muted">{{ authors_text }}</div>{%- endif -%}

      <div class="muted meta">
        {%- if date_value -%}
          <span>{% if date_label != "" %}{{ date_label }} am{% else %}am{% endif %}
            <span class="date" data-date="{{ date_value | escape }}"></span>
          </span>
        {%- endif -%}

        {%- if rating_num > 0 -%}
          <span class="dot">‚≠ê {{ rating_num }}</span><br>
        {%- endif -%}

        {%- if b.isbn -%}
          <span>ISBN <a href="https://www.isbn.de/buch/{{ isbn_str | uri_escape }}/" target="_blank" rel="noopener">{{ isbn_str }}</a></span>
        {%- endif -%}

        {%- if status -%}<span>Status: {{ status }}</span>{%- endif -%}
      </div>

      {%- if pct != "" and pct > 0 and pct <= 100 -%}
        <div class="progress" aria-label="Lesefortschritt">
          <div class="track"><div class="fill" style="width: {{ pct }}%"></div></div>
          <div class="muted" style="margin-top:4px">{{ progress_num }}/{{ pages_num }} Seiten ({{ pct }}%)</div>
        </div>
      {%- endif -%}
    </div>
  </article>
{%- endfor -%}
</div>

<div class="pager" id="pager" hidden>
  <button id="prev" disabled>Zur√ºck</button>
  <span id="pageinfo" class="muted"></span>
  <button id="next">Weiter</button>
</div>

<script>
/**
 * Sortier-/Filter-Logik:
 * 1) Pinned (data-pin="1") immer zuerst
 * 2) Dann nach Datum (data-date) absteigend
 * 3) Filter by Suche, Status, Jahr
 */
(function(){
  const q = document.getElementById('q');
  const statusSel = document.getElementById('status');
  const yearSel = document.getElementById('year');
  const hideNoCover = document.getElementById('hide-nocover');
  const grid = document.getElementById('grid');
  const cards = Array.from(grid.querySelectorAll('.card'));
  const count = document.getElementById('count');

  function sortWithPin(arr){
    return arr.sort((a,b)=>{
      const pa = a.dataset.pin === '1' ? 1 : 0;
      const pb = b.dataset.pin === '1' ? 1 : 0;
      if (pa !== pb) return pb - pa; // pinned zuerst
      const da = a.dataset.date || '';
      const db = b.dataset.date || '';
      if (!da && !db) return 0;
      if (!da) return 1;
      if (!db) return -1;
      return db.localeCompare(da); // neueste zuerst
    });
  }

  function apply(){
    const term = (q?.value || '').trim().toLowerCase();
    const st = (statusSel?.value || '').toLowerCase();
    const yr = (yearSel?.value || '');
    const hideNC = !!(hideNoCover && hideNoCover.checked);

    let visible = 0;

    // sortiere inkl. Pin-Priorit√§t
    sortWithPin(cards).forEach(el => grid.appendChild(el));

    for (const el of cards){
      const title = el.dataset.title || '';
      const author = el.dataset.author || '';
      const status = el.dataset.status || '';
      const year = el.dataset.year || '';
      const hasNoCover = el.dataset.nocover === '1';

      const matches =
        (!term || title.includes(term) || author.includes(term)) &&
        (!st || status === st) &&
        (!yr || year === yr) &&
        (!hideNC || !hasNoCover);

      el.style.display = matches ? '' : 'none';
      if (matches) visible++;
    }
    if (count) count.textContent = visible + ' B√ºcher';
  }

  q?.addEventListener('input', apply);
  statusSel?.addEventListener('change', apply);
  yearSel?.addEventListener('change', apply);
  hideNoCover?.addEventListener('change', apply);

  // Initial
  apply();
})();
</script>
